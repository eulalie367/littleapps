var mustache = require("mustache"),
	handlebars = require("handlebars"),
   url = require("url"),
	libpath = require("path"),
   fs = require("fs");

exports.templateExtension = ".mu";
exports.masterTemplate = "masters/index";

var path = "./Views/";

exports.render = function(dir, model, callback)
{	
	var fileName = libpath.resolve(path + dir + "/index" + exports.templateExtension);
	var master = libpath.resolve(path + exports.masterTemplate + exports.templateExtension);

	//handle null models
	if(typeof(model) == "undefined" || model == null)
	{
		model = { };
	}

	libpath.exists(master, function (exists)
	{
		if(exists)
		{
			fs.readFile(master, "binary", function (err, masterFile)
			{
				if(err == null)
				{
					libpath.exists(fileName, function (exists)
					{
						if(exists)
						{
							fs.readFile(fileName, "binary", function (err, file)
							{
								if(err == null)
								{
									switch(exports.templateExtension)
									{
										case ".mu"://mustache
											var defaultHTML = mustache.render(file, model);
											model.HTML = defaultHTML;
											callback(mustache.render(masterFile, model), false);
										break;
										case ".hbs"://handlebars
											var template = handlebars.compile(file);
											callback(template(model), false);
										break;
									}
								}
								else
								{
									callback(err, true);
								}
							});
						}
						else
						{
							callback("Can't find file " + fileName, true);
						}
					});
				}
				else
				{
					callback(err, true);
				}
			});
		}
		else
		{
			callback("Can't find file " + master, true);
		}
	});
}
